<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moodle XML Тестирование</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            margin: 0;
            padding: 20px;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            padding: 25px 30px;
            text-align: center;
        }
        
        h1 {
            margin: 0;
            font-size: 28px;
        }
        
        .subtitle {
            margin-top: 5px;
            opacity: 0.9;
        }
        
        .main-content {
            display: flex;
            flex-direction: column;
            padding: 25px;
        }
        
        .upload-section, .test-section, .results-section {
            margin-bottom: 30px;
            padding: 20px;
            border-radius: 8px;
            background-color: #f9fafc;
            border: 1px solid #eaeef2;
        }
        
        .section-title {
            margin-top: 0;
            color: #2c3e50;
            border-bottom: 2px solid #eaeef2;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        .url-input-area {
            border: 2px solid #eaeef2;
            border-radius: 8px;
            padding: 25px;
            background-color: white;
        }
        
        .url-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .url-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #eaeef2;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .url-input:focus {
            outline: none;
            border-color: #6a11cb;
        }
        
        .url-input::placeholder {
            color: #999;
        }
        
        .btn {
            background: linear-gradient(to right, #6a11cb, #2575fc);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-qr {
            background: linear-gradient(to right, #11998e, #38ef7d);
        }
        
        .qr-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        
        .qr-modal.active {
            opacity: 1;
            visibility: visible;
        }
        
        .qr-modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transform: translateY(-20px);
            transition: transform 0.3s;
        }
        
        .qr-modal.active .qr-modal-content {
            transform: translateY(0);
        }
        
        .qr-modal h3 {
            margin-top: 0;
            color: #2c3e50;
            margin-bottom: 20px;
        }
        
        #qrScannerContainer {
            margin: 20px 0;
            padding: 20px;
            background-color: #f8f9fa;
            border: 1px solid #eaeef2;
            border-radius: 8px;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        #qrVideo {
            width: 100%;
            max-width: 300px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .qr-instruction {
            margin-top: 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 6px;
            font-size: 14px;
            color: #666;
            text-align: left;
        }
        
        .qr-instruction ol {
            margin: 10px 0 0 0;
            padding-left: 20px;
        }
        
        .qr-instruction li {
            margin-bottom: 8px;
        }
        
        .close-qr-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 15px;
            transition: background-color 0.3s;
        }
        
        .close-qr-btn:hover {
            background: #5a6268;
        }
        
        .example-links {
            margin-top: 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #6a11cb;
        }
        
        .example-links h4 {
            margin-top: 0;
            color: #2c3e50;
        }
        
        .example-links ul {
            margin: 10px 0 0 0;
            padding-left: 20px;
        }
        
        .example-links li {
            margin-bottom: 8px;
        }
        
        .example-link {
            color: #2575fc;
            text-decoration: none;
            cursor: pointer;
            border-bottom: 1px dotted #2575fc;
        }
        
        .example-link:hover {
            color: #6a11cb;
            border-bottom-style: solid;
        }
        
        .timer-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background-color: #2c3e50;
            color: white;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .timer {
            font-size: 28px;
            font-weight: bold;
            font-family: monospace;
        }
        
        .question {
            margin-bottom: 25px;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            border-left: 5px solid #6a11cb;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        }
        
        .question-text {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .answer-option {
            margin-bottom: 10px;
            padding: 12px 15px;
            background-color: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #eaeef2;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .answer-option:hover {
            background-color: #edf2ff;
            border-color: #6a11cb;
        }
        
        .answer-option.selected {
            background-color: #e1e8ff;
            border-color: #2575fc;
        }
        
        .answer-option.correct {
            background-color: #d4edda;
            border-color: #28a745;
        }
        
        .answer-option.incorrect {
            background-color: #f8d7da;
            border-color: #dc3545;
        }
        
        .results-summary {
            text-align: center;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        }
        
        .score {
            font-size: 48px;
            font-weight: bold;
            color: #2575fc;
            margin: 10px 0;
        }
        
        .hidden {
            display: none;
        }
        
        .status-message {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .loading {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .question-counter {
            font-size: 16px;
            color: #7f8c8d;
        }
        
        .test-controls {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
            font-size: 14px;
            border-top: 1px solid #eaeef2;
        }
        
        @media (max-width: 768px) {
            .main-content {
                padding: 15px;
            }
            
            .upload-section, .test-section, .results-section {
                padding: 15px;
            }
            
            .url-input-group {
                flex-direction: column;
            }
            
            .timer-container {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .test-controls {
                flex-direction: column;
                gap: 10px;
            }
            
            .btn {
                width: 100%;
            }
        }
    </style>
    <!-- Подключаем библиотеку для сканирования QR-кодов -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>Moodle XML Тестирование</h1>
            <p class="subtitle">Укажите ссылку на тест в формате Moodle XML и пройдите его с отслеживанием времени и результатов</p>
        </header>
        
        <div class="main-content">
            <!-- Секция загрузки файла по ссылке -->
            <section class="upload-section">
                <h2 class="section-title">Загрузка теста по ссылке</h2>
                
                <div class="url-input-area">
                    <div class="url-input-group">
                        <input type="url" id="urlInput" class="url-input" 
                               placeholder="https://example.com/test.xml" 
                               value="">
                        <button id="loadUrlBtn" class="btn">Загрузить тест</button>
                        <button id="qrCodeBtn" class="btn btn-qr">QR-код</button>
                    </div>
                    
                    <div id="uploadStatus" class="status-message hidden"></div>
                    

                </div>
            </section>
            
            <!-- Секция тестирования -->
            <section id="testSection" class="test-section hidden">
                <h2 class="section-title">Тестирование</h2>
                
                <div class="timer-container">
                    <div>
                        <div>Время тестирования:</div>
                        <div class="timer" id="timer">00:00:00</div>
                    </div>
                    <div class="question-counter">
                        Вопрос <span id="currentQuestion">1</span> из <span id="totalQuestions">0</span>
                    </div>
                </div>
                
                <div id="questionsContainer">
                    <!-- Вопросы будут добавлены здесь динамически -->
                </div>
                
                <div class="test-controls">
                    <button id="prevBtn" class="btn" disabled>Предыдущий вопрос</button>
                    <button id="nextBtn" class="btn">Следующий вопрос</button>
                    <button id="finishBtn" class="btn">Завершить тест</button>
                </div>
            </section>
            
            <!-- Секция результатов -->
            <section id="resultsSection" class="results-section hidden">
                <h2 class="section-title">Результаты тестирования</h2>
                
                <div class="results-summary">
                    <h3>Тест завершен!</h3>
                    <div class="score" id="score">0%</div>
                    <p>Правильных ответов: <span id="correctAnswers">0</span> из <span id="totalAnswers">0</span></p>
                    <p>Затраченное время: <span id="timeSpent">00:00:00</span></p>
                    <button id="restartBtn" class="btn">Пройти тест снова</button>
                </div>
                
                <div id="detailedResults">
                    <!-- Детальные результаты будут добавлены здесь -->
                </div>
            </section>
        </div>
        
        <footer>
            <p>Приложение для тестирования на основе формата Moodle XML</p>
            <p>Укажите ссылку на XML файл теста Moodle, чтобы начать тестирование</p>
        </footer>
    </div>

    <!-- Модальное окно для сканирования QR-кода -->
    <div id="qrModal" class="qr-modal">
        <div class="qr-modal-content">
            <h3>Сканирование QR-кода</h3>
            
            <div id="qrScannerContainer">
                <video id="qrVideo" playsinline></video>
                <div id="qrStatus">Наведите камеру на QR-код</div>
            </div>
            
            <div class="qr-instruction">
                <p><strong>Инструкция:</strong></p>
                <ol>
                    <li>Наведите камеру на QR-код с ссылкой на тест</li>
                    <li>QR-код должен содержать ссылку на Moodle XML файл</li>
                    <li>Ссылка автоматически вставится в поле для загрузки</li>
                    <li>Модальное окно закроется после сканирования</li>
                </ol>
            </div>
            
            <button id="closeQrBtn" class="close-qr-btn">Закрыть сканер</button>
        </div>
    </div>

    <script>
        // Глобальные переменные
        let questions = [];
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let startTime;
        let timerInterval;
        let timeSpent = 0;
        let qrScannerActive = false;
        let videoStream = null;
        
        // Элементы DOM
        const urlInput = document.getElementById('urlInput');
        const loadUrlBtn = document.getElementById('loadUrlBtn');
        const qrCodeBtn = document.getElementById('qrCodeBtn');
        const uploadStatus = document.getElementById('uploadStatus');
        const testSection = document.getElementById('testSection');
        const questionsContainer = document.getElementById('questionsContainer');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const finishBtn = document.getElementById('finishBtn');
        const resultsSection = document.getElementById('resultsSection');
        const scoreElement = document.getElementById('score');
        const correctAnswersElement = document.getElementById('correctAnswers');
        const totalAnswersElement = document.getElementById('totalAnswers');
        const timeSpentElement = document.getElementById('timeSpent');
        const restartBtn = document.getElementById('restartBtn');
        const timerElement = document.getElementById('timer');
        const currentQuestionElement = document.getElementById('currentQuestion');
        const totalQuestionsElement = document.getElementById('totalQuestions');
        const detailedResults = document.getElementById('detailedResults');
        const exampleLinks = document.querySelectorAll('.example-link');
        const qrModal = document.getElementById('qrModal');
        const qrVideo = document.getElementById('qrVideo');
        const qrStatus = document.getElementById('qrStatus');
        const closeQrBtn = document.getElementById('closeQrBtn');
        
        // Обработчики событий
        loadUrlBtn.addEventListener('click', handleUrlLoad);
        
        urlInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleUrlLoad();
            }
        });
        
        qrCodeBtn.addEventListener('click', startQRScanner);
        closeQrBtn.addEventListener('click', stopQRScanner);
        
        // Закрытие модального окна при клике вне его
        qrModal.addEventListener('click', (e) => {
            if (e.target === qrModal) {
                stopQRScanner();
            }
        });
        
        // Закрытие модального окна при нажатии Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && qrModal.classList.contains('active')) {
                stopQRScanner();
            }
        });
        
        // Обработчики для примеров ссылок
        exampleLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const url = e.target.getAttribute('data-url');
                urlInput.value = url;
                handleUrlLoad();
            });
        });
        
        prevBtn.addEventListener('click', () => {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                showQuestion(currentQuestionIndex);
                updateNavigationButtons();
            }
        });
        
        nextBtn.addEventListener('click', () => {
            if (currentQuestionIndex < questions.length - 1) {
                currentQuestionIndex++;
                showQuestion(currentQuestionIndex);
                updateNavigationButtons();
            }
        });
        
        finishBtn.addEventListener('click', finishTest);
        
        restartBtn.addEventListener('click', restartTest);
        
        // Функция запуска сканера QR-кода
        async function startQRScanner() {
            qrModal.classList.add('active');
            document.body.style.overflow = 'hidden';
            qrScannerActive = true;
            qrStatus.textContent = 'Запуск камеры...';
            
            try {
                // Запрашиваем доступ к камере
                videoStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: "environment",
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    },
                    audio: false
                });
                
                qrVideo.srcObject = videoStream;
                qrVideo.setAttribute("playsinline", true); // Для мобильных устройств
                
                await qrVideo.play();
                qrStatus.textContent = 'Наведите камеру на QR-код';
                
                // Запускаем обработчик кадров
                requestAnimationFrame(scanQRCode);
                
            } catch (error) {
                console.error('Ошибка доступа к камере:', error);
                qrStatus.textContent = 'Ошибка доступа к камере. Разрешите доступ к камере в настройках браузера.';
                qrStatus.style.color = 'red';
                
                // Предлагаем ввести ссылку вручную
                setTimeout(() => {
                    const manualUrl = prompt('Введите ссылку на тест вручную:');
                    if (manualUrl && manualUrl.trim()) {
                        urlInput.value = manualUrl.trim();
                        stopQRScanner();
                    }
                }, 1000);
            }
        }
        
        // Функция сканирования QR-кода
        function scanQRCode() {
            if (!qrScannerActive) return;
            
            if (qrVideo.readyState === qrVideo.HAVE_ENOUGH_DATA) {
                const canvas = document.createElement('canvas');
                canvas.width = qrVideo.videoWidth;
                canvas.height = qrVideo.videoHeight;
                const context = canvas.getContext('2d');
                
                // Рисуем текущий кадр видео на canvas
                context.drawImage(qrVideo, 0, 0, canvas.width, canvas.height);
                
                // Получаем данные изображения
                const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                
                // Сканируем QR-код
                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert",
                });
                
                if (code) {
                    // QR-код найден
                    qrStatus.textContent = 'QR-код распознан!';
                    qrStatus.style.color = 'green';
                    
                    // Вставляем ссылку в поле ввода
                    const scannedUrl = code.data;
                    urlInput.value = scannedUrl;
                    
                    // Останавливаем сканер
                    setTimeout(() => {
                        stopQRScanner();
                        showUploadStatus('Ссылка из QR-кода вставлена', 'success');
                        setTimeout(() => {
                            uploadStatus.classList.add('hidden');
                        }, 2000);
                    }, 1000);
                    
                    return; // Прекращаем сканирование
                }
            }
            
            // Продолжаем сканирование
            if (qrScannerActive) {
                requestAnimationFrame(scanQRCode);
            }
        }
        
        // Функция остановки сканера QR-кода
        function stopQRScanner() {
            qrScannerActive = false;
            qrModal.classList.remove('active');
            document.body.style.overflow = 'auto';
            qrStatus.textContent = 'Наведите камеру на QR-код';
            qrStatus.style.color = '';
            
            // Останавливаем видео поток
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            
            if (qrVideo.srcObject) {
                qrVideo.srcObject = null;
            }
        }
        
        // Функция обработки загрузки по URL
        async function handleUrlLoad() {
            const url = urlInput.value.trim();
            
            if (!url) {
                showUploadStatus('Пожалуйста, введите URL XML файла', 'error');
                return;
            }
            
            // Проверка формата URL
            if (!isValidUrl(url)) {
                showUploadStatus('Пожалуйста, введите корректный URL', 'error');
                return;
            }
            
            // Проверка расширения файла (необязательно, но желательно)
            if (!url.toLowerCase().endsWith('.xml')) {
                if (!confirm('URL не заканчивается на .xml. Продолжить загрузку?')) {
                    return;
                }
            }
            
            try {
                showUploadStatus('Загрузка теста...', 'loading');
                loadUrlBtn.disabled = true;
                qrCodeBtn.disabled = true;
                loadUrlBtn.textContent = 'Загрузка...';
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`Ошибка HTTP: ${response.status}`);
                }
                
                const xmlContent = await response.text();
                parseMoodleXML(xmlContent);
                
                if (questions.length > 0) {
                    showUploadStatus(`Успешно загружен тест с ${questions.length} вопросами`, 'success');
                    setTimeout(() => {
                        uploadStatus.classList.add('hidden');
                        startTest();
                    }, 1500);
                } else {
                    showUploadStatus('Не удалось найти вопросы в XML файле', 'error');
                }
            } catch (error) {
                console.error('Ошибка загрузки теста:', error);
                showUploadStatus(`Ошибка загрузки: ${error.message}`, 'error');
            } finally {
                loadUrlBtn.disabled = false;
                qrCodeBtn.disabled = false;
                loadUrlBtn.textContent = 'Загрузить тест';
            }
        }
        
        // Проверка валидности URL
        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }
        
        // Показать статус загрузки
        function showUploadStatus(message, type) {
            uploadStatus.textContent = message;
            uploadStatus.className = 'status-message';
            uploadStatus.classList.add(type);
            uploadStatus.classList.remove('hidden');
        }
        
        // Парсинг XML Moodle (остается без изменений)
        function parseMoodleXML(xmlContent) {
            questions = [];
            
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlContent, 'text/xml');
            
            const questionNodes = xmlDoc.getElementsByTagName('question');
            
            for (let node of questionNodes) {
                const type = node.getAttribute('type');
                
                if (type !== 'multichoice') continue;
                
                const questionTextNode = node.querySelector('questiontext text');
                const questionText = questionTextNode ? questionTextNode.textContent.trim() : '';
                
                if (!questionText) continue;
                
                const answers = [];
                const answerNodes = node.querySelectorAll('answer');
                
                answerNodes.forEach(answerNode => {
                    const answerTextNode = answerNode.querySelector('text');
                    const answerText = answerTextNode ? answerTextNode.textContent.trim() : '';
                    const fraction = parseFloat(answerNode.getAttribute('fraction') || 0);
                    const isCorrect = fraction > 0;
                    
                    if (answerText) {
                        answers.push({
                            text: answerText,
                            isCorrect: isCorrect
                        });
                    }
                });
                
                if (answers.length === 0) continue;
                
                questions.push({
                    text: questionText,
                    answers: answers,
                    userAnswer: null,
                    isCorrect: false
                });
            }
            
            console.log(`Найдено ${questions.length} вопросов`);
        }
        
        // Начать тест
        function startTest() {
            userAnswers = new Array(questions.length).fill(null);
            
            testSection.classList.remove('hidden');
            totalQuestionsElement.textContent = questions.length;
            
            startTime = new Date();
            timeSpent = 0;
            updateTimer();
            timerInterval = setInterval(updateTimer, 1000);
            
            showQuestion(0);
            updateNavigationButtons();
        }
        
        // Показать вопрос
        function showQuestion(index) {
            currentQuestionElement.textContent = index + 1;
            questionsContainer.innerHTML = '';
            
            const question = questions[index];
            
            const questionElement = document.createElement('div');
            questionElement.className = 'question';
            
            const questionTextElement = document.createElement('div');
            questionTextElement.className = 'question-text';
            questionTextElement.innerHTML = question.text;
            questionElement.appendChild(questionTextElement);
            
            question.answers.forEach((answer, answerIndex) => {
                const answerElement = document.createElement('div');
                answerElement.className = 'answer-option';
                
                if (userAnswers[index] === answerIndex) {
                    answerElement.classList.add('selected');
                }
                
                answerElement.textContent = answer.text;
                
                answerElement.addEventListener('click', () => {
                    const allOptions = questionElement.querySelectorAll('.answer-option');
                    allOptions.forEach(opt => opt.classList.remove('selected'));
                    
                    answerElement.classList.add('selected');
                    userAnswers[index] = answerIndex;
                    
                    updateNavigationButtons();
                });
                
                questionElement.appendChild(answerElement);
            });
            
            questionsContainer.appendChild(questionElement);
        }
        
        // Обновить кнопки навигации
        function updateNavigationButtons() {
            prevBtn.disabled = currentQuestionIndex === 0;
            nextBtn.disabled = currentQuestionIndex === questions.length - 1;
            
            finishBtn.style.display = currentQuestionIndex === questions.length - 1 ? 'inline-block' : 'none';
            nextBtn.style.display = currentQuestionIndex === questions.length - 1 ? 'none' : 'inline-block';
        }
        
        // Обновить таймер
        function updateTimer() {
            const now = new Date();
            timeSpent = Math.floor((now - startTime) / 1000);
            
            const hours = Math.floor(timeSpent / 3600);
            const minutes = Math.floor((timeSpent % 3600) / 60);
            const seconds = timeSpent % 60;
            
            timerElement.textContent = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        // Завершить тест
        function finishTest() {
            clearInterval(timerInterval);
            
            let correctCount = 0;
            
            questions.forEach((question, index) => {
                const userAnswerIndex = userAnswers[index];
                
                if (userAnswerIndex !== null && userAnswerIndex !== undefined) {
                    const isCorrect = question.answers[userAnswerIndex].isCorrect;
                    question.isCorrect = isCorrect;
                    question.userAnswer = userAnswerIndex;
                    
                    if (isCorrect) {
                        correctCount++;
                    }
                } else {
                    question.isCorrect = false;
                    question.userAnswer = null;
                }
            });
            
            showResults(correctCount);
        }
        
        // Показать результаты
        function showResults(correctCount) {
            testSection.classList.add('hidden');
            resultsSection.classList.remove('hidden');
            
            const percentage = Math.round((correctCount / questions.length) * 100);
            
            scoreElement.textContent = `${percentage}%`;
            correctAnswersElement.textContent = correctCount;
            totalAnswersElement.textContent = questions.length;
            timeSpentElement.textContent = timerElement.textContent;
            
            showDetailedResults();
        }
        
        // Показать детальные результаты
        function showDetailedResults() {
            detailedResults.innerHTML = '<h3>Подробные результаты:</h3>';
            
            questions.forEach((question, index) => {
                const resultElement = document.createElement('div');
                resultElement.className = 'question';
                
                const status = question.isCorrect ? '✓ Правильно' : '✗ Неправильно';
                const statusClass = question.isCorrect ? 'correct' : 'incorrect';
                
                resultElement.innerHTML = `
                    <div class="question-text">Вопрос ${index + 1}: ${question.text}</div>
                    <div class="answer-option ${statusClass}">${status}</div>
                    <div><strong>Ваш ответ:</strong> ${
                        question.userAnswer !== null 
                        ? question.answers[question.userAnswer].text 
                        : 'Нет ответа'
                    }</div>
                    <div><strong>Правильный ответ:</strong> ${
                        question.answers.find(a => a.isCorrect)?.text || 'Не определен'
                    }</div>
                `;
                
                detailedResults.appendChild(resultElement);
            });
        }
        
        // Перезапустить тест
        function restartTest() {
            resultsSection.classList.add('hidden');
            
            userAnswers = new Array(questions.length).fill(null);
            currentQuestionIndex = 0;
            
            startTest();
        }
        
        // Инструкция при загрузке
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Приложение Moodle XML тестирования загружено');
            
            // Автоматическая загрузка примера при открытии
            setTimeout(() => {
                const exampleUrl = "https://raw.githubusercontent.com/moodle/moodle/master/question/format/xml/tests/fixtures/multichoice.xml";
                urlInput.value = exampleUrl;
            }, 1000);
        });
    </script>
</body>
</html>